{% extends "base.html" %}

{% block title %}Trading Dashboard - AI Trading System{% endblock %}

{% block head %}
<style>
    .trading-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 400px 300px 300px;
        gap: 20px;
        height: 100vh;
    }
    
    .chart-container {
        position: relative;
        background: #1a1a1a;
        border-radius: 10px;
        padding: 15px;
        overflow: hidden;
    }
    
    .chart-3d {
        grid-column: 1 / -1;
        height: 400px;
    }
    
    .neural-viz {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .metrics-panel {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .trading-controls {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .risk-panel {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .floating-widget {
        position: fixed;
        top: 100px;
        right: 20px;
        width: 300px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 1000;
    }
    
    .holographic-border {
        border: 2px solid transparent;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7, #fd79a8);
        background-size: 400% 400%;
        animation: gradient 3s ease infinite;
        border-radius: 10px;
        position: relative;
    }
    
    @keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    
    .neural-node {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #00ff88;
        position: absolute;
        box-shadow: 0 0 10px #00ff88;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }
    
    .market-data-stream {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        color: #00ff00;
        background: #000;
        padding: 10px;
        border-radius: 5px;
        height: 200px;
        overflow-y: auto;
    }
    
    .performance-ring {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: conic-gradient(#00ff88 0deg, #ff0088 180deg, #0088ff 360deg);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        position: relative;
    }
    
    .performance-ring::before {
        content: '';
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: #fff;
        position: absolute;
    }
    
    .performance-value {
        z-index: 1;
        font-weight: bold;
        color: #333;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Main Trading Grid -->
    <div class="trading-grid">
        <!-- 3D Portfolio Visualization -->
        <div class="chart-container chart-3d holographic-border">
            <h5 class="text-white mb-3">
                <i class="fas fa-cube me-2"></i>3D Portfolio Risk Surface
            </h5>
            <div id="portfolio-3d" style="height: 100%;"></div>
        </div>
        
        <!-- Neural Network Visualization -->
        <div class="chart-container neural-viz">
            <h5 class="text-white mb-3">
                <i class="fas fa-brain me-2"></i>Neural Network Activity
            </h5>
            <div id="neural-network-viz" style="height: 100%;"></div>
        </div>
        
        <!-- Real-time Metrics -->
        <div class="chart-container metrics-panel">
            <h5 class="text-white mb-3">
                <i class="fas fa-chart-line me-2"></i>Performance Metrics
            </h5>
            <div class="row h-100">
                <div class="col-6">
                    <div class="performance-ring">
                        <div class="performance-value">
                            <div id="sharpe-ratio">0.00</div>
                            <small>Sharpe</small>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="performance-ring">
                        <div class="performance-value">
                            <div id="total-return">0.00%</div>
                            <small>Return</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Trading Controls -->
        <div class="chart-container trading-controls">
            <h5 class="text-white mb-3">
                <i class="fas fa-gamepad me-2"></i>Trading Controls
            </h5>
            <div class="row">
                <div class="col-12 mb-3">
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-success" id="manual-buy">
                            <i class="fas fa-arrow-up me-1"></i>BUY
                        </button>
                        <button type="button" class="btn btn-warning" id="manual-hold">
                            <i class="fas fa-pause me-1"></i>HOLD
                        </button>
                        <button type="button" class="btn btn-danger" id="manual-sell">
                            <i class="fas fa-arrow-down me-1"></i>SELL
                        </button>
                    </div>
                </div>
                <div class="col-12 mb-3">
                    <label class="form-label text-white">Position Size</label>
                    <input type="range" class="form-range" id="position-size" min="1" max="10" value="1">
                    <div class="text-white text-center" id="position-size-value">1 Contract</div>
                </div>
                <div class="col-12">
                    <label class="form-label text-white">Risk Level</label>
                    <select class="form-select" id="risk-level">
                        <option value="conservative">Conservative</option>
                        <option value="moderate" selected>Moderate</option>
                        <option value="aggressive">Aggressive</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Risk Management -->
        <div class="chart-container risk-panel">
            <h5 class="text-white mb-3">
                <i class="fas fa-shield-alt me-2"></i>Risk Management
            </h5>
            <div class="row h-100">
                <div class="col-6">
                    <div class="text-center">
                        <h6 class="text-white">Max Drawdown</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: 0%" id="drawdown-bar"></div>
                        </div>
                        <small class="text-white" id="drawdown-value">0.00%</small>
                    </div>
                </div>
                <div class="col-6">
                    <div class="text-center">
                        <h6 class="text-white">VaR (95%)</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" id="var-bar"></div>
                        </div>
                        <small class="text-white" id="var-value">$0.00</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Price Chart -->
        <div class="chart-container">
            <h5 class="text-white mb-3">
                <i class="fas fa-chart-candlestick me-2"></i>NQ Futures Price
            </h5>
            <canvas id="price-chart" style="height: 100%;"></canvas>
        </div>
    </div>
    
    <!-- Floating AI Assistant -->
    <div class="floating-widget" id="ai-assistant">
        <h6 class="mb-3">
            <i class="fas fa-robot me-2"></i>AI Assistant
        </h6>
        <div class="market-data-stream" id="ai-recommendations">
            <div class="text-success">AI System Online</div>
            <div class="text-info">Analyzing market conditions...</div>
            <div class="text-warning">Waiting for trading signals...</div>
        </div>
        <div class="mt-3">
            <button class="btn btn-sm btn-primary w-100" id="toggle-ai">
                <i class="fas fa-power-off me-1"></i>AI Active
            </button>
        </div>
    </div>
</div>

<!-- Session Selection Modal -->
<div class="modal fade" id="sessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Trading Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="list-group" id="session-list">
                    <!-- Sessions will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Chart Controls -->
<div class="position-fixed bottom-0 start-0 p-3">
    <div class="card" style="width: 300px;">
        <div class="card-body">
            <h6 class="card-title">Chart Settings</h6>
            <div class="mb-2">
                <label class="form-label">Timeframe</label>
                <select class="form-select form-select-sm" id="timeframe">
                    <option value="1m">1 Minute</option>
                    <option value="5m">5 Minutes</option>
                    <option value="15m">15 Minutes</option>
                    <option value="1h">1 Hour</option>
                    <option value="4h">4 Hours</option>
                    <option value="1d">1 Day</option>
                </select>
            </div>
            <div class="mb-2">
                <label class="form-label">Indicators</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="show-sma" checked>
                    <label class="form-check-label" for="show-sma">SMA (20)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="show-bollinger">
                    <label class="form-check-label" for="show-bollinger">Bollinger Bands</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="show-rsi">
                    <label class="form-check-label" for="show-rsi">RSI</label>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/trading_dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/3d_visualization.js') }}"></script>
<script src="{{ url_for('static', filename='js/neural_network_viz.js') }}"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize trading dashboard
    const dashboard = new TradingDashboard();
    dashboard.init();
    
    // Initialize 3D visualization
    const viz3D = new Portfolio3DVisualization('portfolio-3d');
    viz3D.init();
    
    // Initialize neural network visualization
    const neuralViz = new NeuralNetworkVisualization('neural-network-viz');
    neuralViz.init();
    
    // Initialize charts
    const charts = new TradingCharts();
    charts.initPriceChart('price-chart');
    
    // Check for session parameter
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');
    
    if (sessionId) {
        dashboard.loadSession(sessionId);
    } else {
        // Show session selection modal
        loadAvailableSessions();
    }
    
    // Manual trading controls
    document.getElementById('manual-buy').addEventListener('click', function() {
        dashboard.placeTrade('buy');
    });
    
    document.getElementById('manual-sell').addEventListener('click', function() {
        dashboard.placeTrade('sell');
    });
    
    document.getElementById('manual-hold').addEventListener('click', function() {
        dashboard.placeTrade('hold');
    });
    
    // Position size slider
    document.getElementById('position-size').addEventListener('input', function(e) {
        document.getElementById('position-size-value').textContent = e.target.value + ' Contract' + (e.target.value > 1 ? 's' : '');
    });
    
    // Chart settings
    document.getElementById('timeframe').addEventListener('change', function(e) {
        charts.updateTimeframe(e.target.value);
    });
    
    document.getElementById('show-sma').addEventListener('change', function(e) {
        charts.toggleIndicator('sma', e.target.checked);
    });
    
    document.getElementById('show-bollinger').addEventListener('change', function(e) {
        charts.toggleIndicator('bollinger', e.target.checked);
    });
    
    document.getElementById('show-rsi').addEventListener('change', function(e) {
        charts.toggleIndicator('rsi', e.target.checked);
    });
    
    // AI Assistant toggle
    document.getElementById('toggle-ai').addEventListener('click', function() {
        dashboard.toggleAI();
    });
});

function loadAvailableSessions() {
    fetch('/api/session_status/active')
        .then(response => response.json())
        .then(sessions => {
            const sessionList = document.getElementById('session-list');
            sessionList.innerHTML = '';
            
            if (sessions.length === 0) {
                sessionList.innerHTML = '<div class="list-group-item text-center text-muted">No active sessions found</div>';
            } else {
                sessions.forEach(session => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item list-group-item-action';
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${session.name}</h6>
                            <small>${session.algorithm_type}</small>
                        </div>
                        <p class="mb-1">Episode ${session.current_episode}/${session.total_episodes}</p>
                        <small>Profit: $${session.total_profit.toFixed(2)}</small>
                    `;
                    item.addEventListener('click', function() {
                        window.location.href = `/trading_dashboard?session_id=${session.id}`;
                    });
                    sessionList.appendChild(item);
                });
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('sessionModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading sessions:', error);
            showAlert('Error loading sessions', 'danger');
        });
}
</script>
{% endblock %}
